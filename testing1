using System;
using System.Collections.Generic;
using System.IO;
using System.Net.Http;
using System.Text;
using System.Text.Json;
using System.Threading.Tasks;

public class MultiEndpointTestRunner
{
    private readonly HttpClient _httpClient;
    private readonly string _apiKey;
    private readonly Dictionary<string, string> _endpointMapping;
    
    public MultiEndpointTestRunner(string baseUrl, string apiKey)
    {
        _httpClient = new HttpClient { BaseAddress = new Uri(baseUrl) };
        _apiKey = apiKey;
        
        // Map file prefixes/patterns to endpoints
        _endpointMapping = new Dictionary<string, string>
        {
            { "payment", "/api/payments" },
            { "customer", "/api/customers" },
            { "order", "/api/orders" }
        };
    }
    
    public async Task RunTestsAsync(string folderPath)
    {
        var jsonFiles = Directory.GetFiles(folderPath, "*.json");
        
        foreach (string filePath in jsonFiles)
        {
            string fileName = Path.GetFileName(filePath).ToLower();
            
            try
            {
                Console.Write($"Processing {fileName}... ");
                
                // Read JSON content
                string jsonContent = await File.ReadAllTextAsync(filePath);
                
                // Determine endpoint based on filename
                string endpoint = GetEndpointFromFileName(fileName);
                
                if (endpoint == null)
                {
                    Console.WriteLine($"✗ SKIPPED - No endpoint mapping found");
                    continue;
                }
                
                // Post to appropriate endpoint
                var response = await PostToEndpointAsync(endpoint, jsonContent);
                
                if (response.IsSuccessStatusCode)
                {
                    Console.WriteLine($"✓ SUCCESS - Posted to {endpoint}");
                }
                else
                {
                    Console.WriteLine($"✗ FAILED - Status: {response.StatusCode}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"✗ ERROR - {ex.Message}");
            }
        }
    }
    
    private string GetEndpointFromFileName(string fileName)
    {
        // Check which endpoint mapping matches the filename
        foreach (var mapping in _endpointMapping)
        {
            if (fileName.StartsWith(mapping.Key, StringComparison.OrdinalIgnoreCase))
            {
                return mapping.Value;
            }
        }
        return null;
    }
    
    private async Task<HttpResponseMessage> PostToEndpointAsync(string endpoint, string jsonContent)
    {
        var request = new HttpRequestMessage(HttpMethod.Post, endpoint)
        {
            Content = new StringContent(jsonContent, Encoding.UTF8, "application/json")
        };
        
        request.Headers.Add("X-API-Key", _apiKey);
        request.Headers.Add("Idempotency-Key", Guid.NewGuid().ToString());
        
        return await _httpClient.SendAsync(request);
    }
}

// Usage - files named like: payment-test1.json, customer-test1.json, order-test1.json
public class Program
{
    public static async Task Main(string[] args)
    {
        var runner = new MultiEndpointTestRunner("https://api.example.com", "your-api-key");
        await runner.RunTestsAsync(@"C:\TestData\JsonFiles");
    }
}
